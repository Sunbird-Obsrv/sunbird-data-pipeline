---
- name: Create content-snapshot directory
  file:
    path: '{{ content_snapshot_path }}'
    state: directory
  become: yes
  become_user: "{{ analytics_user }}"
  tags: deploy


- name: Ensure removing jars directory
  file:
    path: '{{ content_snapshot_path }}jars'
    state: absent
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"  
  tags: deploy

- name: Create jars directory
  file:
    path: '{{ content_snapshot_path }}jars'
    state: directory
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"    
  tags: deploy

- name: Copy adhoc-jobs jar file
  copy:
    src: "{{ content_snapshot_jar_name }}"
    dest: "{{ content_snapshot_path }}jars/"
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"    
  tags: deploy

- name: Ensure removing config directory
  file:
    path: '{{ content_snapshot_path }}config'
    state: absent
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"    
  tags: deploy

- name: Create config directory
  file:
    path: "{{ content_snapshot_path }}config"
    state: directory
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"    
  tags: deploy

- name: Ensure copying all conf files from the templates/conf folder
  template:
    src: "conf/{{ item }}.j2"
    dest: "{{ content_snapshot_path }}config/{{ item }}.conf"
    mode: 755
  with_items: "{{ config_files }}"
  tags: deploy

- name: Ensure removing scripts directory
  file:
    path: '{{ content_snapshot_path }}scripts'
    state: absent
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"  
  tags: deploy

- name: Create scripts directory
  file:
    path: '{{ content_snapshot_path }}scripts'
    state: directory
    mode: 755
  become: yes
  become_user: "{{ analytics_user }}"  
  tags: deploy

- name: Ensure copying all script files from the templates/script dir
  template:
    src: "scripts/{{ item }}.j2"
    dest: "{{ content_snapshot_path }}scripts/{{ item }}.sh"
    mode: 755
  with_items: "{{ script_files }}"
  tags: deploy

- name: Run Script
  become: yes
  become_user: "{{ analytics_user }}"
  shell: "nohup {{ content_snapshot_path }}scripts/run-script.sh {{ script_to_run }} &"
  poll: 0
  tags: run-script




