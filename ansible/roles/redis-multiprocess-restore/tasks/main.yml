---

- name: Create the directory
  become: yes
  become_user: "{{ redis_restore_user }}"
  file: path=/tmp/{{ item }} state=directory recurse=yes
  with_items: "{{ redis_restore_process }}"

- name: download a file from azure storage
  include_role:
    name: azure-cloud-storage
    tasks_from: blob-download.yml
  vars:
    blob_container_name: "{{ redis_backup_storage }}"
    blob_file_name: "{{ item }}/{{ redis_restore_file_name }}"
    local_file_or_folder_path: "/tmp/{{ item }}/{{ redis_restore_file_name }}"
    storage_account_name: "{{ azure_management_storage_account_name }}"
    storage_account_key: "{{ azure_management_storage_account_key }}"
  with_items: "{{ redis_restore_process }}"
  when: cloud_service_provider == "azure"

- name: get redis process ports to stop 
  shell: "echo {{ lookup ('vars', item + '_port') }}"
  register: ports
  with_items: "{{ redis_restore_process }}" 

- name: stop redis to restore backup 
  become: yes
  become_user: "{{ redis_restore_user }}"
  shell: "echo shutdown | {{ analytics_user_home }}/redis-stable/src/redis-cli -p {{ item.stdout }}"
  with_items: "{{ ports.results }}"

- name: Extract backup zip into tmp
  become: yes
  become_user: "{{ redis_restore_user }}"
  unarchive:
    src: "/tmp/{{ item }}/{{ redis_restore_file_name }}"
    dest: "/tmp/{{ item }}"
    remote_src: True
  with_items: "{{ redis_restore_process }}"  

- name: copy dump.rdb files to data dir
  become: yes
  become_user: "{{ redis_restore_user }}"
  shell: cp /tmp/{{ item }}/{{ item }}-dump.rdb {{ analytics_user_home }}/redis-stable/{{ item }}-dump.rdb
  with_items: "{{ redis_restore_process }}"

- name: start redis
  become: yes
  become_user: "{{ redis_restore_user }}"
  command: '{{ analytics_user_home }}/redis-stable/src/redis-server {{ analytics_user_home }}/redis-stable/redis-{{ item }}.conf'
  with_items: "{{ redis_restore_process }}"

- name: Keyspace info
  shell: "echo info keyspace | {{ analytics_user_home }}/redis-stable/src/redis-cli -p {{ item.stdout }}"
  register: restoreinfo
  with_items: "{{ ports.results }}"

- debug: var=item.stdout_lines
  with_items: "{{ restoreinfo.results }}"  
